<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Agendador de Salas Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Agendamento de Salas</h1>

        <div class="card">
            <div class="card-body">
                <form action="/" method="POST" id="agendamentoForm">
                    <div class="mb-3">
                        <label for="nome_evento" class="form-label"><strong>Nome do Evento</strong></label>
                        <input type="text" class="form-control" id="nome_evento" name="nome_evento"
                            placeholder="Ex: Palestra de tecnologia" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="inicio_str" class="form-label"><strong>Horário de Início</strong></label>
                            <select class="form-select" id="inicio_str" name="inicio_str" required>
                                {% for h in horarios %}
                                <option value="{{ h }}">{{ h }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="fim_str" class="form-label"><strong>Horário de Fim</strong></label>
                            <select class="form-select" id="fim_str" name="fim_str" required>
                                {% for h in horarios %}
                                <option value="{{ h }}">{{ h }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label"><strong>Serviços de Internet (Capacidade de banda: 500
                                Mbps)</strong></label>
                        <div class="row">
                            {% for servico, peso in servicos_db.items() %}
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="checkbox" name="servicos"
                                            value="{{ servico }}" id="serv-{{ loop.index }}">
                                    </div>
                                    <label class="form-control" for="serv-{{ loop.index }}">{{ servico }} (Peso: {{ peso
                                        }} Mbps)</label>
                                    <select class="form-select" name="prioridade_servico_{{ servico }}">
                                        {% for prio, valor in prioridades_db.items() %}
                                        <option value="{{ prio }}" {% if prio=='Média' %}selected{% endif %}>{{ prio }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Equipamentos Eletrônicos (Capacidade: 3
                                Espaços)</strong></label>
                        <div class="row">
                            {% for equip, peso in equipamentos_db.items() %}
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="checkbox" name="equipamentos"
                                            value="{{ equip }}" id="equip-{{ loop.index }}">
                                    </div>
                                    <label class="form-control" for="equip-{{ loop.index }}">{{ equip }} (Peso: {{ peso
                                        }} Espaço(s))</label>
                                    <select class="form-select" name="prioridade_equipamento_{{ equip }}">
                                        {% for prio, valor in prioridades_db.items() %}
                                        <option value="{{ prio }}" {% if prio=='Média' %}selected{% endif %}>{{ prio }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-primary mt-3">Agendar e Otimizar
                        Recursos</button>
                    <small id="timeError" class="text-danger ms-3 d-none">Horário de início e fim não podem ser
                        iguais.</small>
                </form>
            </div>
        </div>

        {% if erro %}
        <div class="alert alert-danger mt-5">
            <strong>Falha na Validação ou Agendamento</strong>
            <p>{{ erro }}</p>
        </div>
        {% endif %}


        {% if resultado %}
        <div class="alert alert-success mt-5">
            <strong>Agendamento Confirmado!</strong>
            <p>O evento <strong>{{ resultado.evento.nome }}</strong> foi agendado na <strong>{{ resultado.sala
                    }}</strong>
                (das {{ "%02d:%02d"|format(resultado.evento.inicio//60, resultado.evento.inicio%60) }}
                às {{ "%02d:%02d"|format(resultado.evento.fim//60, resultado.evento.fim%60) }}).
            </p>
            <hr>
            <h5 class="alert-heading">Resultado da Alocação de Recursos (Mochilas)</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Banda Larga:</strong>
                        {{ "%.1f"|format(resultado.peso_banda) }} / {{ "%.0f"|format(resultado.capacidade_banda) }}
                        (Mbps) utilizados.</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Eletrônicos:</strong>
                        {{ "%.0f"|format(resultado.peso_eletronicos) }} / {{
                        "%.0f"|format(resultado.capacidade_eletronicos) }} (Espaços) utilizados.</p>
                </div>
            </div>
            <p><strong>Valor de Prioridade Total Obtido: {{ "%.1f"|format(resultado.valor_total) }}</strong></p>

            <ul class="list-group">
                {% if not resultado.alocacoes %}
                <li class="list-group-item">Nenhum serviço ou equipamento foi solicitado.</li>
                {% endif %}
                {% for item in resultado.alocacoes|sort(attribute='valor_ganho', reverse=True) %}
                <li
                    class="list-group-item d-flex justify-content-between align-items-center
                    {% if item.fracao_alocada == 0 %}list-group-item-danger{% elif item.fracao_alocada < 1 %}list-group-item-warning{% else %}list-group-item-success{% endif %}">
                    <div>
                        <strong>{{ item.nome_item }}</strong>
                        <br><small>Alocado: {{ "%.1f"|format(item.fracao_alocada * 100) }}% |
                            Peso: {{ "%.1f"|format(item.peso_alocado) }} |
                            Valor: {{ "%.1f"|format(item.valor_ganho) }}</small>
                    </div>
                    {% if item.fracao_alocada == 1 %}
                    <span class="badge bg-success rounded-pill">100% Garantido</span>
                    {% elif item.fracao_alocada > 0 %}
                    <span class="badge bg-warning text-dark rounded-pill">Parcial</span>
                    {% else %}
                    <span class="badge bg-danger rounded-pill">Recusado</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="mt-5">
            <h2>Agendamentos Atuais</h2>
            {% if not agendamentos_atuais %}
            <p>Nenhum agendamento realizado ainda.</p>
            {% endif %}
            {% for sala_nome, agendamentos in agendamentos_atuais.items()|sort %}
            {% if agendamentos %}
            <div class="card mt-3">
                <div class="card-header">
                    <strong>{{ sala_nome }}</strong> (Banda: 500, Eletrônicos: 3)
                </div>
                <ul class="list-group list-group-flush">
                    {% for agendamento in agendamentos|sort(attribute='evento.inicio') %}
                    <li class="list-group-item">
                        <strong>{{ agendamento.evento.nome }}</strong>
                        (das {{ "%02d:%02d"|format(agendamento.evento.inicio//60, agendamento.evento.inicio%60) }}
                        às {{ "%02d:%02d"|format(agendamento.evento.fim//60, agendamento.evento.fim%60) }})
                        <br>

                        <small class="text-muted">
                            Valor Total: {{ "%.0f"|format(agendamento.valor_total) }} |
                            Banda: {{ "%.0f"|format(agendamento.peso_banda_total) }} / 500 |
                            Itens: {{ "%.0f"|format(agendamento.peso_eletronicos_total) }} / 3

                            {% set garantidos = [] %}
                            {% for item in agendamento.recursos_alocados if item.fracao_alocada == 1.0 %}
                            {% set _ = garantidos.append(item.nome_item) %}
                            {% endfor %}
                            {% if garantidos %}
                            <br><span class="text-success"><strong>Garantidos:</strong> {{ garantidos|join(', ')
                                }}</span>
                            {% endif %}

                            {% set parciais = [] %}
                            {% for item in agendamento.recursos_alocados if 0 < item.fracao_alocada < 1.0 %} {% set
                                item_formatado=item.nome_item ~ ' (' ~ "%.0f" |format(item.fracao_alocada * 100) ~ '%)'
                                %} {% set _=parciais.append(item_formatado) %} {% endfor %} {% if parciais %} <br><span
                                    class="text-warning text-dark"><strong>Parciais:</strong> {{ parciais|join(', ')
                                    }}</span>
                                {% endif %}
                        </small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% endfor %}
        </div>

    </div>

    <script>
        const form = document.getElementById('agendamentoForm');
        const timeError = document.getElementById('timeError');

        form.addEventListener('submit', function (event) {
            const inicio = document.getElementById('inicio_str').value;
            const fim = document.getElementById('fim_str').value;

            // Valida Horários
            if (inicio === fim) {
                event.preventDefault(); // Impede o envio do formulário
                timeError.classList.remove('d-none');
            } else {
                timeError.classList.add('d-none');
            }
        });
    </script>
</body>

</html>